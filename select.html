<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Repo â€” Space</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      h1 { margin-bottom: 30px; }
      .repo {
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
        cursor: pointer;
      }
      .repo:hover {
        background: #f5f5f5;
      }
      .repo-name { font-weight: bold; }
      .repo-desc { color: #666; font-size: 0.9em; }
      .status { margin-top: 20px; color: #666; }
    </style>
  </head>
  <body>
    <h1 id="heading">Select a repository</h1>
    <div id="repos"></div>
    <div id="templates" style="display: none;"></div>
    <div class="status" id="status"></div>

    <script>
      const sessionId = localStorage.getItem('session_id')
      if (!sessionId) {
        window.location.href = '/'
      }

      const reposDiv = document.getElementById('repos')
      const templatesDiv = document.getElementById('templates')
      const statusDiv = document.getElementById('status')
      const heading = document.getElementById('heading')

      let selectedRepo = null

      fetch('/api/repos', {
        headers: { Authorization: `Bearer ${sessionId}` }
      })
        .then(r => r.json())
        .then(repos => {
          repos.forEach(repo => {
            const div = document.createElement('div')
            div.className = 'repo'
            div.innerHTML = `
              <div class="repo-name">${repo.full_name}</div>
              <div class="repo-desc">${repo.description || 'No description'}</div>
            `
            div.onclick = () => selectRepo(repo)
            reposDiv.appendChild(div)
          })
        })
        .catch(err => {
          statusDiv.textContent = `Error: ${err.message}`
        })

      function selectRepo(repo) {
        selectedRepo = repo
        reposDiv.style.display = 'none'
        templatesDiv.style.display = 'block'
        heading.textContent = 'Choose your goal'

        fetch('/api/templates', {
          headers: { Authorization: `Bearer ${sessionId}` }
        })
          .then(r => r.json())
          .then(templates => {
            templates.forEach(template => {
              const div = document.createElement('div')
              div.className = 'repo'
              div.innerHTML = `<div class="repo-name">${template.name}</div>`
              div.onclick = () => provision(template.id)
              templatesDiv.appendChild(div)
            })
          })
          .catch(err => {
            statusDiv.textContent = `Error: ${err.message}`
          })
      }

      function provision(template) {
        statusDiv.textContent = `Provisioning ${selectedRepo.name}...`
        fetch('/api/provision', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${sessionId}`
          },
          body: JSON.stringify({
            clone_url: selectedRepo.clone_url,
            name: selectedRepo.name,
            template: template
          })
        })
          .then(r => r.json())
          .then(data => {
            if (data.error) {
              statusDiv.textContent = `Error: ${data.error}`
            } else {
              window.location.href = `/dashboard/${data.project_id}`
            }
          })
          .catch(err => {
            statusDiv.textContent = `Error: ${err.message}`
          })
      }
    </script>
  </body>
</html>
